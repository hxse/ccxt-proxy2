# 测试策略与覆盖说明

本测试套件旨在验证缓存系统的完整性、连续性和边界条件处理。

## 测试目录结构

```
Test/
  conftest.py          # Pytest Fixtures (临时目录、Mock 数据配置)
  utils.py             # 测试辅助函数 (Mock生成、连续性断言)
  test_storage.py      # 存储层测试
  test_log_manager.py  # 日志管理测试
  test_continuity.py   # 连续性检查测试
  test_integration.py  # 集成测试
  test_cache_algorithm.py # 缓存算法专项测试
```

---

## 1. 测试基础设施

### `conftest.py`
- **`temp_dir`**: 为每个测试用例提供独立的临时目录，测试结束后自动清理。
- **`sample_loc`**: 提供标准的 `DataLocation` 对象（Binance/BTC_USDT/15m）。

### `utils.py`
- **`mock_ohlcv(start, count, period_ms)`**: 生成可预测的 Mock 数据（价格随时间线性递增），便于验证。
- **`assert_time_continuous(df)`**: 验证 DataFrame 中的时间戳是否严格连续。

---

## 2. 存储层测试 (`test_storage.py`)

验证底层的 Parquet 读写能力。

- **写入与读取**: 验证首次写入后能否正确读取。
- **追加连续数据**: 验证首尾重叠的数据写入后，能否正确合并并去重（10+10-1=19）。
- **时间范围过滤**: 验证 `read_ohlcv` 的 `start` / `end` 参数是否有效。
- **幂等性**: 验证重复写入相同数据不会产生副作用。
- **模式隔离**: 验证 `live` 和 `demo` 模式的数据是否严格隔离，互不干扰。

---

## 3. 日志管理测试 (`test_log_manager.py`)

验证日志的记录、合并与重建。

- **日志追加**: 验证 `append_log` 能正确写入 JSONL。
- **日志合并 (`compact_log`)**:
    - **连续合并**: 验证 `t1-t2` 和 `t2-t3` 能合并为 `t1-t3`。
    - **重叠合并**: 验证 `t1-t3` 和 `t2-t4` 能合并为 `t1-t4`。
    - **断裂保持**: 验证中间有断裂的日志不会被错误合并。
- **日志重建 (`rebuild_log_from_data`)**:
    - 验证从数据文件重建日志的功能。
    - **保守策略验证**: 确认即使数据物理上有断裂，重建的日志也会保守地视为一个连续段（符合设计预期）。

---

## 4. 连续性测试 (`test_continuity.py`)

验证连续性检查工具的准确性。

- **无断裂场景**: 验证连续或重叠的日志不报告 Gap。
- **断裂检测**: 验证中间缺失的数据段能被正确识别为 Gap。
- **缺失范围计算**: 验证 `find_missing_ranges` 能正确计算出目标范围内所有缺失的时间段（头部缺失、中间断裂、尾部缺失）。

---

## 5. 集成测试 (`test_integration.py`)

验证 `get_ohlcv_with_cache` 的完整工作流。

- **完整流程**: 首次获取 → 缓存写入 → 追加获取 → 连续性验证。
- **缓存命中**: 验证当请求范围在缓存内时，**不会**触发 fetch 回调（零网络请求）。
- **数据隔离**: 再次验证不同 DataLocation 之间的数据互不影响。

---

## 6. 缓存算法专项测试 (`test_cache_algorithm.py`)

专门针对"简化缓存算法"的边界场景测试。

- **起始命中 (Start in Cache)**: 起始时间在缓存内，应复用缓存，仅请求后续数据。
- **起始未命中 (Start NOT in Cache)**: 起始时间不在缓存内，应直接发起网络请求。
- **无起始时间 (None Start)**: 必须跳过缓存读取，强制刷新最新数据。
- **网络返回不足**: 模拟网络数据源耗尽，验证算法能正确退出循环。
- **中间缓存不复用**: 验证简化算法的特性——即使请求范围覆盖了中间某段缓存，也不会去复用它（这是为了降低算法复杂度做的权衡）。
